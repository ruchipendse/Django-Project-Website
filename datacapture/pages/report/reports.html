{% extends 'base.html' %}
{% block content_2 %}
    {% if not user.is_authenticated %}
        <script>
            window.location.href = "/";
        </script>
    {% endif %}

    <meta id="report_datesJsondata" data="{{report_datesJson}}" />
    <h2>Weekly Reports:</h2>

    <div class = "reports"> 
        <form name = "reportsForm" action = "reports" method = "POST">
            {% csrf_token %} 
            <input type = "hidden" id = "selectedCriteria" name = "selectedCriteria" value = "USER"/>
            <div id = 'date_div' align = 'left'>
                <table>
                    <tr>
                        <td><label id="label_criteria" for = "criteria" disabled>Criteria</label></td>
                        <td>
                            <select id = "report_criteria" name = "report_criteria"  style="min-width:100%;">
                                <option value = "USER">User</option>
                                <!-- <option value = "MACHINE">Machine</option> -->
                                <!-- <option VALUE = PART"">Part</option> -->
                            </select>
                        </td>
                        <td><label id="label_to_date" for = "to_date" disabled>Week ending on</label></td>
                        <td>
                            <table>
                                <tr>
                                    <td align = "right">
                                        <input type="submit" id = "prevWeekButton" class="w3-button w3-blue w3-tiny" value="Prev"
                                                onclick = "prevWeek();" />
                                    </td>
                                    <td align = "center">
                                        <input type = "text" id = "to_date" name = "to_date" readonly="readonly" size="10" value = "{{selected_date}}" min="2020-08-01">
                                    </td>
                                    <td align = "left">
                                        <input type="submit" id = "nextWeekButton" class="w3-button w3-blue w3-tiny" value="Next"
                                                onclick = "nextWeek();" />
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>
                            <a  href="report_download/USER/{{selected_date}}"> Download</a>
                        </td>
                    </tr>
                </table>
            </div>
            <table id = "report_table"  width = 95%  class = "unselected_report_cell">
                <tr >
                    <th  width="20%" class = "unselected_report_cell">User</th>
                {% for day in report_dates %}
                    <th id = {{day}}  class = "unselected_report_cell">{{day}}</th>

                {% endfor %}
                </tr>
                {% for key, value in userwise_report_data.items %}
                <tr>
                    <td id = "user_column_highlight" class = "user_column_highlight unselected_report_cell">{{key}}</td>
                    {% for key1, value1 in value.items %}
                    <td onclick="alert('{{key1}} - {{key}}')" onmouseenter = "mark_red(this)" onmouseleave = "unmark_red(this)"  class = "unselected_report_cell"  style="cursor: pointer;">
                        <table id = "{{key1}} - {{key}}" width = "100%" class = "unselected_report_cell">
                            <tr>
                                <td id = "td_parts_expected" class = "td_parts_expected unselected_report_cell"  
                                        width="50%" align = "right" title="Efficiency">
                                        {{value1.efficiency}}%
                                </td>
                            </tr>
                            <tr>
                                <td id = "td_parts_actual" class = "td_parts_actual unselected_report_cell"  
                                        width="50%" align = "right" title="Production">
                                        {{value1.production}}%
                                </td>
                            </tr>
                            <tr>
                                <td id = "td_parts_actual" class = "td_parts_actual unselected_report_cell"  
                                        width="50%" align = "right" title="Activity">
                                        {{value1.activity}}%
                                </td>
                            </tr>
                        </table>                        
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </form>
    </div>

<script>
    function mark_red(comp_table){
        comp_table.classList.remove("unselected_report_cell")
        comp_table.classList.add("selected_report_cell")
    }

    function unmark_red(comp_table){
        comp_table.classList.remove("selected_report_cell")
        comp_table.classList.add("unselected_report_cell")
    }

    function setFunctionMode(fMode){
        document.getElementById('functionMode').value =  fMode;
    }

    function prevWeek(){
        var present_date        = document.getElementById('to_date').value;
        var date_parts          = present_date.split ('-');
        var prev_date           = new Date(parseInt(date_parts[0]), parseInt(date_parts[1]) - 1, 
                                        parseInt(date_parts[2]) - 7);
        var earliest_date       = new Date("2020-08-01");       // REMOVE THIS HARD CODING LATER
        if (prev_date >= earliest_date){
            document.getElementById('to_date').value   = formatDate(prev_date);
        } else {
            alert ("Can not go before " + earliest_date);
        }
        setFunctionMode('GENERATE');
    }

    function nextWeek(){
        var present_date        = document.getElementById('to_date').value;
        var date_parts          = present_date.split ('-');
        var next_date           = new Date(parseInt(date_parts[0]), parseInt(date_parts[1]) - 1, 
                                                parseInt(date_parts[2]) + 7);
        var today               = new Date();
        if (next_date <= today){
            document.getElementById('to_date').value              = formatDate(next_date);
        } else {
            alert ("Can not go beyond current date");
        }
        setFunctionMode('GENERATE');
    }

    function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();
    
        if (month.length < 2) 
            month = '0' + month;
        if (day.length < 2) 
            day = '0' + day;
    
        return [year, month, day].join('-');
    }

    /**
        THIS METHOD INITAITES THE STATUS OF REQUIRED FIELDS ON USERS PAGE 
    */
    function init(){
        var weekdays = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
        var months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        document.getElementById('to_date').setAttribute('max', new Date().toISOString().split("T")[0]);
        var report_datesJson = document.getElementById('report_datesJsondata').getAttribute("data");
        var report_dates = JSON.parse(report_datesJson);
        for (var i = 0; i < report_dates.length; i++){
            dateObj = new Date(report_dates[i])
            tdTag = document.getElementById(report_dates[i]);
            tdTag.innerHTML = "<pre>" + 
                            dateObj.getFullYear() + "-" +  dateObj.getMonth() + "-" + dateObj.getDate() 
                            + "\n" + weekdays[dateObj.getDay()]
                            + "</pre>";
        }
    }

    init();
</script>
{% endblock %}
